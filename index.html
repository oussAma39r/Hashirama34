<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام مراقبة الفريزرات – v9</title>
<style>
  :root{
    --bg:#2f3640;
    --section-bg:#353b48;
    --table-bg:#2d3436;
    --border:#636e72;
    --text:#ecf0f1;
    --accent:#00cec9;
  }
  *{box-sizing:border-box;font-family:'Arial',sans-serif;}
  body{margin:0;background:var(--bg);color:var(--text);}
  /* Sidebar */
  .sidebar{
    height:100%;width:0;position:fixed;z-index:3;top:0;right:0;
    background:#111;overflow-x:hidden;transition:0.3s;padding-top:60px;
  }
  .sidebar a{
    display:block;padding:10px 30px;font-size:18px;color:#f1f1f1;text-decoration:none;
  }
  .sidebar a:hover{background:#575757;}
  .sidebar .closebtn{position:absolute;top:0;right:25px;font-size:36px;}
  .openbtn{
    font-size:30px;cursor:pointer;color:#fff;position:fixed;top:15px;right:15px;z-index:4;
  }
  /* Sections */
  .sectionPage{display:none;padding:80px 20px;}
  .section{background:var(--section-bg);padding:20px;border-radius:8px;margin-bottom:20px;}
  /* Inputs */
  input,select,textarea,button{
    padding:8px;margin:5px;border-radius:4px;border:1px solid var(--border);
    background:var(--table-bg);color:var(--text);
  }
  button{cursor:pointer;background:var(--accent);color:#000;font-weight:bold;}
  /* Table */
  table{width:100%;border-collapse:collapse;background:var(--table-bg);font-size:14px;}
  th,td{border:1px solid #555;padding:8px;text-align:center;color:#fff;}
  th{background:var(--border);}
  .image-preview{max-width:150px;max-height:120px;object-fit:contain;display:block;margin:auto;border:1px solid #ccc;border-radius:4px;box-shadow:0 0 5px rgba(0,0,0,0.4);}
  canvas{max-width:100%;margin-top:20px;}
</style>
</head>
<body>

<!-- Hamburger -->
<span class="openbtn" onclick="toggleSidebar()">&#9776;</span>

<!-- Sidebar -->
<div id="mySidebar" class="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="toggleSidebar()">&times;</a>
  <a href="#" onclick="showSection('entrySection')">ادخال مشكلة جديدة</a>
  <a href="#" onclick="showSection('dateSection')">التقارير حسب التاريخ</a>
  <a href="#" onclick="showSection('summarySection');scrollToAnchor('dailyReportTitle')">التقرير اليومي</a>

</div>

<!-- إدخال مشكلة جديدة -->
<div id="entrySection" class="sectionPage" style="display:block;">
  <div class="section">
    <h2>إدخال مشكلة جديدة</h2>
    <label>كود المجمدة:</label>
    <input type="text" id="ean6" oninput="chercherCongelateur()" placeholder="048813">
    <label>اسم الفريزر:</label>
    <input type="text" id="freezerName" readonly>
    <br>
    <label>المشكلة:</label>
    <select id="problem">
      <option value="تلف الإطار البلاستيكي">تلف الإطار البلاستيكي</option>
      <option value="كسر في الباب">كسر في الباب</option>
      <option value="تسرب غاز">تسرب غاز</option>
      <option value="عطل في الضاغط">عطل في الضاغط</option>
      <option value="خدوش أو انبعاجات أثناء النقل">خدوش أو انبعاجات أثناء النقل</option>
      <option value="إمالة الهيكل أثناء النقل">إمالة الهيكل أثناء النقل</option>
      <option value="مشاكل القالب الداخلي">مشاكل القالب الداخلي</option>
      <option value="مشاكل القالب الخارجي">مشاكل القالب الخارجي</option>
      <option value="مشاكل الإطار البلاستيكي">مشاكل الإطار البلاستيكي</option>
      <option value="مشاكل أخرى">مشاكل أخرى</option>
    </select>
    <label>رقم القالب:</label>
    <select id="moldNumber"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>لا يتعلق بالقالب</option></select>
    <br>
    <label>وصف المشكلة:</label>
    <textarea id="description" rows="2"></textarea>
    <br>
    <label>صورة:</label>
    <input type="file" id="imageInput" accept="image/*" capture="environment" onchange="previewImage()">
    <div id="imagePreviewContainer" style="display:none;"></div>
    <br>
    <label>التاريخ:</label><input type="date" id="date">
    <label>الوقت:</label><input type="time" id="time">
    <label>الفترة:</label>
    <select id="period"><option value="صباحية">صباحية</option><option value="مسائية">مسائية</option></select>
    <br>
    <button onclick="addRow()">إضافة للسجل</button>
  </div>
</div>

<!-- التقارير حسب التاريخ (جدول السجل) -->
<div id="dateSection" class="sectionPage">
  <div class="section">
    <h2>التقارير حسب التاريخ</h2>
    <label>تاريخ السجل:</label><input type="date" id="loadDate">
    <button onclick="loadData()">عرض</button>
    <button onclick="saveData()">حفظ بيانات هذا التاريخ</button>
    <button onclick="clearTable()">محو الجدول</button>
    <input type="text" id="filenameInput" placeholder="اسم الملف">
    <button onclick="exportTable('pdf')">PDF تحميل</button>
    <button onclick="exportTable('excel')">Excel تحميل</button>
    <button onclick="exportOBB()">حفظ كل البيانات في ملف OBB</button>
    <br>
    <table id="logTable" style="width:85%;margin:auto;">
      <thead><tr>
        <th>التاريخ</th><th>الوقت</th><th>الفترة</th><th>اسم الفريزر</th>
        <th>المشكلة</th><th>رقم القالب</th><th>وصف</th><th>الصورة</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ملخص الأضرار -->
<div id="summarySection" class="sectionPage">
  <div class="section">
    <h2>ملخص الأضرار</h2>
    <select id="chartType" onchange="drawChart()">
      <option value="bar">عمودي</option><option value="pie">دائري</option><option value="line">خطي</option>
    </select>
    <canvas id="damageChart" height="200"></canvas>
    <br>
    <button onclick="exportSummaryCombinedPDF()">تحميل ملخص PDF</button>
    <div id="summaryDetails">
      <h3 id="dailyReportTitle">التقرير اليومي</h3>
      <table id="dailyProblemTable"><thead><tr><th>المشكلة</th><th>عدد (اليوم)</th></tr></thead><tbody></tbody></table>
      <h3>تفصيل الأضرار حسب القالب (يومي)</h3>
      <table id="dailyMoldTable"><thead><tr><th>رقم</th><th>عدد</th></tr></thead><tbody></tbody></table>
      <h3>تفصيل الأضرار حسب نوع المشكلة</h3>
      <table id="problemSummaryTable"><thead><tr><th>المشكلة</th><th>عدد</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js">
/* Export all logs to OBB */
function exportOBB(){
  const allLogs = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('log-')){
      allLogs[k] = localStorage.getItem(k);
    }
  }
  if(Object.keys(allLogs).length===0){
    alert('لا توجد بيانات محفوظة بعد');
    return;
  }
  const blob = new Blob([JSON.stringify(allLogs)], {type:'application/octet-stream'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'freezer_logs.obb';
  a.click();
  URL.revokeObjectURL(a.href);
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
/* Export all logs to OBB */
function exportOBB(){
  const allLogs = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('log-')){
      allLogs[k] = localStorage.getItem(k);
    }
  }
  if(Object.keys(allLogs).length===0){
    alert('لا توجد بيانات محفوظة بعد');
    return;
  }
  const blob = new Blob([JSON.stringify(allLogs)], {type:'application/octet-stream'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'freezer_logs.obb';
  a.click();
  URL.revokeObjectURL(a.href);
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
/* Export all logs to OBB */
function exportOBB(){
  const allLogs = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('log-')){
      allLogs[k] = localStorage.getItem(k);
    }
  }
  if(Object.keys(allLogs).length===0){
    alert('لا توجد بيانات محفوظة بعد');
    return;
  }
  const blob = new Blob([JSON.stringify(allLogs)], {type:'application/octet-stream'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'freezer_logs.obb';
  a.click();
  URL.revokeObjectURL(a.href);
}

</script>

<script>
  /* Sidebar toggle */
  function toggleSidebar(){
    const bar=document.getElementById('mySidebar');
    bar.style.width = bar.style.width === '250px' ? '0' : '250px';
  }
  function showSection(id){
    document.querySelectorAll('.sectionPage').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
    toggleSidebar();
  }
  function scrollToAnchor(id){setTimeout(()=>{document.getElementById(id)?.scrollIntoView({behavior:'smooth'});},300);}

  /* Data logic (copied & adapted from previous versions) */
  let mainChart=null;
  const congels={"048813":"CFH-MT260V4W","048752":"CFH-MT260V4G","039965":"CFH-MT26","048516":"CFH-T130V2G","050595":"KFV240W","035844":"CRD58V4W"};
  const imageData={};

  document.addEventListener('DOMContentLoaded',()=>{
    const t=new Date();
    document.getElementById('date').valueAsDate=t;
    document.getElementById('time').value=t.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
    drawChart();updateSummaryTables();updateProblemSummary();updateDailyProblemSummary();
  });

  function chercherCongelateur(){document.getElementById('freezerName').value=congels[document.getElementById('ean6').value]||'غير معروف';}
  function previewImage(){
    const f=document.getElementById('imageInput').files[0];const p=document.getElementById('imagePreviewContainer');
    if(!f){p.style.display='none';return;}
    const reader=new FileReader();
    reader.onload=e=>{
      p.innerHTML=`<img src="${e.target.result}" class="image-preview">`;p.style.display='block';
    };reader.readAsDataURL(f);
  }
  function addRow(){
    const body=document.querySelector('#logTable tbody');
    const date=document.getElementById('date').value,time=document.getElementById('time').value,
      period=document.getElementById('period').value,name=document.getElementById('freezerName').value||'غير معروف',
      problem=document.getElementById('problem').value,mold=document.getElementById('moldNumber').value,
      desc=document.getElementById('description').value,f=document.getElementById('imageInput');
    const appendRow=(imgSrc)=>{
      body.insertAdjacentHTML('beforeend',`<tr><td>${date}</td><td>${time}</td><td>${period}</td><td>${name}</td><td>${problem}</td><td>${mold}</td><td>${desc}</td><td>${imgSrc?'<img src="'+imgSrc+'" class="image-preview">':'لا يوجد'}</td></tr>`);
      document.getElementById('description').value='';document.getElementById('imageInput').value='';document.getElementById('imagePreviewContainer').style.display='none';
      drawChart();updateSummaryTables();updateProblemSummary();updateDailyProblemSummary();
    };
    if(f.files.length>0){const reader=new FileReader();reader.onload=e=>{appendRow(e.target.result);};reader.readAsDataURL(f.files[0]);}
    else appendRow(null);
  }

  function exportTable(type){
    if(type==='excel'){
      const clone=document.getElementById('logTable').cloneNode(true);
      clone.querySelectorAll('img').forEach(i=>i.parentElement.innerHTML='نعم');
      const blob=new Blob([clone.outerHTML],{type:'application/vnd.ms-excel'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(document.getElementById('filenameInput').value||'log')+'.xls';a.click();
    }else{
      downloadSectionAsPDF('logTable','log','p',true);
    }
  }

  function drawChart(){
    const ctx=document.getElementById('damageChart').getContext('2d');
    if(mainChart) mainChart.destroy();
    const counts={};document.querySelectorAll('#logTable tbody tr').forEach(r=>{const p=r.children[4].innerText;counts[p]=(counts[p]||0)+1;});
    mainChart=new Chart(ctx,{type:document.getElementById('chartType').value,data:{labels:Object.keys(counts),datasets:[{label:'عدد',data:Object.values(counts),backgroundColor:Object.keys(counts).map(()=>'#'+Math.floor(Math.random()*16777215).toString(16))}]},options:{plugins:{legend:{rtl:true}}}});
  }
  function updateSummaryTables(){
  const today=new Date();
  const counts={};
  document.querySelectorAll('#logTable tbody tr').forEach(r=>{
    const d=r.children[0].innerText;
    if(!d) return;
    const diff=(today - new Date(d))/(864e5);
    if(diff<=1){
      const mold=r.children[5].innerText || 'غير محدد';
      counts[mold]=(counts[mold]||0)+1;
    }
  });
  const tbody=document.querySelector('#dailyMoldTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  for(const [m,c] of Object.entries(counts)){
    tbody.innerHTML+=`<tr><td>${m}</td><td>${c}</td></tr>`;
  }
}
  function updateProblemSummary(){
    const counts={};document.querySelectorAll('#logTable tbody tr').forEach(r=>{const p=r.children[4].innerText;counts[p]=(counts[p]||0)+1;});
    const tb=document.querySelector('#problemSummaryTable tbody');tb.innerHTML='';for(const [p,c] of Object.entries(counts)){tb.innerHTML+=`<tr><td>${p}</td><td>${c}</td></tr>`;}
  }
  function updateDailyProblemSummary(){
    const dateKey=document.getElementById('loadDate').value||new Date().toISOString().split('T')[0];
    const counts={};document.querySelectorAll('#logTable tbody tr').forEach(r=>{if(r.children[0].innerText===dateKey){const p=r.children[4].innerText;counts[p]=(counts[p]||0)+1;}});
    const tb=document.querySelector('#dailyProblemTable tbody');tb.innerHTML='';for(const [p,c] of Object.entries(counts)){tb.innerHTML+=`<tr><td>${p}</td><td>${c}</td></tr>`;}
  }
  /* Save / Load */
  function saveData(){const k=document.getElementById('loadDate').value;if(!k){alert('اختر تاريخ');return;}localStorage.setItem('log-'+k,document.querySelector('#logTable tbody').innerHTML);alert('تم الحفظ');}
  function loadData(){const k=document.getElementById('loadDate').value;if(!k){alert('اختر تاريخ');return;}document.querySelector('#logTable tbody').innerHTML=localStorage.getItem('log-'+k)||'';drawChart();updateSummaryTables();updateProblemSummary();updateDailyProblemSummary();}
  function clearTable(){if(confirm('محو الكل؟')){document.querySelector('#logTable tbody').innerHTML='';updateSummaryTables();updateProblemSummary();updateDailyProblemSummary();}}

  /* PDF helpers (from v8) */
  function downloadSectionAsPDF(id,name,orientation='p',header=false){
    const el=document.getElementById(id);
    html2canvas(el,{scale:2,useCORS:true}).then(canvas=>{
      const img=canvas.toDataURL('image/jpeg',1.0);
      const {jsPDF}=window.jspdf;const pdf=new jsPDF(orientation,'mm','a4',true);
      const pdfW=orientation==='l'?pdf.internal.pageSize.getHeight():pdf.internal.pageSize.getWidth();
      const pdfH=pdf.internal.pageSize.getHeight();
      if(header)addHeaderFooter(pdf);
      pdf.addImage(img,'JPEG',25,30,pdfW-50,pdfH-50);
      pdf.save(name+'.pdf');
    });
  }
  function addHeaderFooter(pdf){
    const w=pdf.internal.pageSize.getWidth(),h=pdf.internal.pageSize.getHeight();
    pdf.setFontSize(12);pdf.text('Contrôle Qualité',w-10,15,{align:'right'});
    pdf.text('Visa Superviseur Qualité',10,h-10);pdf.text('Visa Agent Qualité',w-10,h-10,{align:'right'});
    pdf.setDrawColor(100);pdf.rect(20,25,w-40,h-50);
  }
  function exportSummaryCombinedPDF(){downloadSectionAsPDF('summarySection','ملخص_الأضرار','p',true);}

/* Export all logs to OBB */
function exportOBB(){
  const allLogs = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('log-')){
      allLogs[k] = localStorage.getItem(k);
    }
  }
  if(Object.keys(allLogs).length===0){
    alert('لا توجد بيانات محفوظة بعد');
    return;
  }
  const blob = new Blob([JSON.stringify(allLogs)], {type:'application/octet-stream'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'freezer_logs.obb';
  a.click();
  URL.revokeObjectURL(a.href);
}

</script>
</body>
</html>
